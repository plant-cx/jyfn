<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/32/6969/6969728.png" type="image" sizes="64x64">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose Message</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #3e3831; /* Dark background */
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #e0d9d0;
        }

        .header-bg {
            background-color: #5a524a;
            background-image: linear-gradient(to right, #5a524a, #6d645b);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
        }

        .header-center-content {
            flex-grow: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* New button/focus styles for the form */
        .send-button-bg {
            background-color: #8c7e73;
        }
        .send-button-bg:hover:not(:disabled) {
            background-color: #a39486;
        }
        .message-input-bg {
            background-color: #6d645b;
        }
    </style>
</head>

<body>
    <header class="header-bg text-white shadow-md">
        <div>
            <a href="index.html" class="text-white text-sm font-semibold hover:text-gray-300 transition-colors duration-200 whitespace-nowrap">Home</a>
        </div>

        <div class="header-center-content">
            <img src="https://cdn-icons-png.flaticon.com/32/6969/6969728.png" alt="Mail Logo" class="w-8 h-8 mr-2">
            <h1 class="text-xl font-extrabold tracking-wide whitespace-nowrap">Send a Message</h1>
        </div>

        <div class="text-right">
            <a href="contribution.html" class="text-xs opacity-90 whitespace-nowrap text-white no-underline hover:underline">Credits</a>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl bg-white text-[#3e3831] p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center text-[#5a524a]">Compose New Message ðŸ“§</h2>
            <form id="email-form" class="space-y-4">
                <div id="auth-status" class="text-sm text-center text-red-500 mb-4 hidden">Authentication failed. Please check your connection.</div>

                <div>
                    <label for="recipient-input" class="block text-sm font-medium text-gray-700">Recipient:</label>
                    <input
                        type="email"
                        id="recipient-input"
                        value="admin@mysite.com"
                        readonly
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 cursor-not-allowed"
                    />
                </div>

                <div>
                    <label for="subject-input" class="block text-sm font-medium text-gray-700">Subject:</label>
                    <input
                        type="text"
                        id="subject-input"
                        placeholder="Enter subject here..."
                        maxlength="100"
                        required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-[#8c7e73] focus:ring-[#8c7e73]"
                        disabled
                    />
                </div>

                <div>
                    <label for="body-input" class="block text-sm font-medium text-gray-700">Message:</label>
                    <textarea
                        id="body-input"
                        rows="8"
                        placeholder="Type your message..."
                        required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-[#8c7e73] focus:ring-[#8c7e73]"
                        disabled
                    ></textarea>
                </div>

                <button
                    type="submit"
                    id="send-email-button"
                    class="w-full send-button-bg text-white px-4 py-2 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Send Message
                </button>
                <div id="success-message" class="text-center text-green-600 hidden mt-4 font-semibold">Your message has been sent!</div>
                <div id="form-error-message" class="text-center text-red-600 hidden mt-4 font-semibold">An error occurred. Please try again.</div>
            </form>
        </div>
    </main>
    
    <footer class="message-input-bg p-3 shadow-lg flex justify-center text-xs text-[#e0d9d0]">
        <p>Your message will be securely stored and reviewed by the site administrator.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // === 1. CONFIGURATION ===
        const firebase_configuration_settings = {
            apiKey: "AIzaSyCN5LWuSS5V2Js8JhLEm7KCiuYZA-BP0a0",
            authDomain: "chat-d312d.firebaseapp.com",
            projectId: "chat-d312d",
            storageBucket: "chat-d312d.firebasestorage.app",
            messagingSenderId: "153824285530",
            appId: "1:153824285530:web:d918e824233704842fd963",
            measurementId: "G-CJKMEBMWD2"
        };

        const LIST_OF_ADJECTIVES = ["Happy", "Brave", "Clever", "Swift"];
        const LIST_OF_NOUNS = ["Panda", "Tiger", "Star", "Cloud"];

        // === 2. HELPER FUNCTIONS ===
        function create_a_random_username() {
            const random_adjective = LIST_OF_ADJECTIVES[Math.floor(Math.random() * LIST_OF_ADJECTIVES.length)];
            const random_noun = LIST_OF_NOUNS[Math.floor(Math.random() * LIST_OF_NOUNS.length)];
            return `${random_adjective}${random_noun}`;
        }

        function get_the_users_username() {
            let my_username = sessionStorage.getItem('chatUser');
            if (!my_username) {
                my_username = create_a_random_username();
                sessionStorage.setItem('chatUser', my_username);
            }
            return my_username;
        }

        function enable_form(enabled) {
            the_subject_input_field.disabled = !enabled;
            the_body_input_field.disabled = !enabled;
            the_send_email_button.disabled = !enabled;
        }

        function display_message(element, message, type) {
            the_success_message_display.classList.add('hidden');
            the_error_message_display.classList.add('hidden');
            element.textContent = message;
            element.classList.remove('hidden');
            
            // Auto-hide success message after 5 seconds
            if (type === 'success') {
                setTimeout(() => element.classList.add('hidden'), 5000);
            }
        }

        // === 3. DOM ELEMENTS & VARIABLES ===
        const the_email_form = document.getElementById('email-form');
        const the_recipient_input_field = document.getElementById('recipient-input');
        const the_subject_input_field = document.getElementById('subject-input');
        const the_body_input_field = document.getElementById('body-input');
        const the_send_email_button = document.getElementById('send-email-button');
        const the_success_message_display = document.getElementById('success-message');
        const the_error_message_display = document.getElementById('form-error-message');
        const the_auth_status = document.getElementById('auth-status');

        let my_user_id = null;
        let my_user_name = get_the_users_username();

        // Initialize Firebase app and services
        const my_firebase_app = initializeApp(firebase_configuration_settings);
        const my_firebase_auth = getAuth(my_firebase_app);
        const my_firestore_db = getFirestore(my_firebase_app);
        const my_firestore_messages_collection = collection(my_firestore_db, `apps/${firebase_configuration_settings.projectId}/messages`);

        // === 4. INITIALIZATION AND AUTHENTICATION ===
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(my_firebase_auth, async (authenticated_user) => {
                if (authenticated_user) {
                    // User is logged in (anonymously)
                    my_user_id = authenticated_user.uid;
                    enable_form(true);
                    the_auth_status.classList.add('hidden');
                } else {
                    // User is not logged in, attempt anonymous sign-in
                    try {
                        await signInAnonymously(my_firebase_auth);
                        // onAuthStateChanged will trigger again with the user object
                    } catch (an_authentication_error) {
                        display_message(the_auth_status, 'Authentication failed. Form disabled.', 'error');
                        enable_form(false);
                    }
                }
            });

            // === 5. FORM SUBMISSION HANDLER ===
            the_email_form.addEventListener('submit', async (the_submit_event) => {
                the_submit_event.preventDefault();

                if (!my_user_id) {
                    display_message(the_error_message_display, "Authentication is still loading. Please wait.", 'error');
                    return;
                }

                enable_form(false); // Disable form during submission
                the_error_message_display.classList.add('hidden');
                the_success_message_display.classList.add('hidden');

                const subject = the_subject_input_field.value.trim();
                const body = the_body_input_field.value.trim();
                const recipient = the_recipient_input_field.value; 

                if (subject === '' || body === '') {
                    display_message(the_error_message_display, "Subject and Message body cannot be empty.", 'error');
                    enable_form(true);
                    return;
                }

                try {
                    // Store the message data in Firestore
                    await addDoc(my_firestore_messages_collection, {
                        subject: subject,
                        body: body,
                        recipient: recipient,
                        timestamp: serverTimestamp(),
                        senderUserId: my_user_id,
                        senderUsername: my_user_name
                    });
                    
                    // Success
                    display_message(the_success_message_display, "Your message has been sent successfully!", 'success');
                    the_subject_input_field.value = '';
                    the_body_input_field.value = '';
                    
                } catch (a_sending_error) {
                    // Error
                    display_message(the_error_message_display, `Failed to send message: ${a_sending_error.message}`, 'error');
                } finally {
                    enable_form(true); // Re-enable form
                }
            });
        });
    </script>
</body>

</html>
