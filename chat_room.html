<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Chat & Auth System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Styling */
        body { 
            font-family: sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #3e3831; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            color: #e0d9d0; 
        }
        .header-bg { 
            background-color: #5a524a; 
            padding: 1rem; 
            text-align: center; 
        }
        
        /* Auth Screen Styling */
        .auth-container { 
            max-width: 400px; 
            margin: 50px auto; 
            padding: 20px; 
            background-color: #6d645b; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        }
        
        /* Chat Screen Styling */
        .chat-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        }
        .message-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background-color: #3e3831; 
        }
        .message-item { 
            background-color: #5a524a; 
            padding: 8px; 
            border-radius: 8px; 
            margin-bottom: 5px; 
        }
        .sender-name { 
            font-weight: bold; 
            color: #e0d9d0; 
            margin-right: 10px; 
        }
        .chat-header { 
            background-color: #5a524a; 
            padding: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* Shared Form Styling */
        .input-style { 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #a39486; 
            color: #3e3831; 
            margin-bottom: 10px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .button-style { 
            padding: 10px; 
            border-radius: 4px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .primary-button { 
            background-color: #8c7e73; 
            color: white; 
        }
        .primary-button:hover { 
            background-color: #a39486; 
        }
    </style>
</head>
<body>

    <header class="header-bg text-white shadow-md">
        <h1 class="text-2xl font-bold">User Messaging System</h1>
    </header>

    <main id="auth-screen" class="flex-1">
        <div class="auth-container">
            <h2 id="auth-title" class="text-xl font-bold mb-4 text-center">Sign Up</h2>
            <div id="auth-error" class="text-red-400 mb-3 hidden"></div>
            
            <form id="auth-form">
                <input type="text" id="auth-username" placeholder="Choose a Username (for messaging)" class="input-style" required>
                <input type="email" id="auth-email" placeholder="Email" class="input-style" required>
                <input type="password" id="auth-password" placeholder="Password" class="input-style" required>
                
                <button type="submit" id="auth-button" class="button-style primary-button w-full mb-3">Sign Up</button>
            </form>
            
            <button id="toggle-auth" class="text-sm text-center w-full underline hover:text-gray-300">Switch to Sign In</button>
        </div>
    </main>

    <main id="chat-screen" class="chat-container hidden">
        <div class="chat-header">
            <span id="current-username" class="text-lg font-bold"></span>
            <button id="signout-button" class="button-style bg-red-500 text-white text-sm">Sign Out</button>
        </div>

        <div class="message-area" id="message-area">
            <div class="text-center text-gray-400 mt-4">Messages will appear here once you send one.</div>
        </div>

        <div class="p-3 bg-gray-700">
            <form id="message-form" class="flex space-x-2">
                <select id="recipient-select" class="input-style flex-none w-1/4" required>
                    <option value="" disabled selected>Select Recipient</option>
                    </select>
                <input type="text" id="message-input" placeholder="Type your message..." class="input-style flex-grow m-0" required>
                <button type="submit" class="button-style primary-button flex-none px-6">Send</button>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, getDocs, doc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ðŸ›‘ðŸ›‘ðŸ›‘ IMPORTANT: REPLACE THIS CONFIGURATION WITH YOUR FIREBASE KEYS ðŸ›‘ðŸ›‘ðŸ›‘
        const firebaseConfig = {
            apiKey: "AIzaSyDeqptWAAAHH4A7DsDN8jTtcG3B58WJ_lo",
            authDomain: "email-58cbc.firebaseapp.com",
            projectId: "email-58cbc",
            storageBucket: "email-58cbc.firebasestorage.app",
            messagingSenderId: "143713140342",
            appId: "1:143713140342:web:06935ad0e6345f1b3fa957",
            measurementId: "G-1TWC25TVKL"
        };
        // ðŸ›‘ðŸ›‘ðŸ›‘ END OF FIREBASE CONFIGURATION ðŸ›‘ðŸ›‘ðŸ›‘

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleAuthButton = document.getElementById('toggle-auth');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const usernameInput = document.getElementById('auth-username');
        const emailInput = document.getElementById('auth-email');
        const passwordInput = document.getElementById('auth-password');
        const currentUsernameDisplay = document.getElementById('current-username');
        const recipientSelect = document.getElementById('recipient-select');
        const messageArea = document.getElementById('message-area');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');


        let isSigningIn = false;
        let currentUserId = null;
        let currentUserName = null;
        let usersMap = {}; // Map of UID to username

        // --- Utility Functions ---

        function displayError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        function clearError() {
            authError.classList.add('hidden');
            authError.textContent = '';
        }

        function toggleAuthMode() {
            isSigningIn = !isSigningIn;
            if (isSigningIn) {
                authTitle.textContent = 'Sign In';
                authButton.textContent = 'Sign In';
                toggleAuthButton.textContent = 'Switch to Sign Up';
                usernameInput.style.display = 'none';
            } else {
                authTitle.textContent = 'Sign Up';
                authButton.textContent = 'Sign Up';
                toggleAuthButton.textContent = 'Switch to Sign In';
                usernameInput.style.display = 'block';
            }
            clearError();
        }

        // 1. Stores new user's username in the separate 'users' collection
        async function storeUserMetadata(uid, username) {
            await setDoc(doc(db, "users", uid), {
                username: username,
                uid: uid
            });
        }

        // 2. Loads the list of all users for the recipient dropdown
        async function loadUsers() {
            // Preserve the "Select Recipient" option
            recipientSelect.innerHTML = '<option value="" disabled selected>Select Recipient</option>';
            usersMap = {};
            try {
                const q = query(collection(db, "users"), orderBy("username"));
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Don't show the current user in the recipient list
                    if (userData.uid !== currentUserId) {
                        usersMap[userData.uid] = userData.username;
                        const option = document.createElement('option');
                        option.value = userData.uid;
                        option.textContent = userData.username;
                        recipientSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("Error loading users:", error);
            }
        }

        // 3. Displays a single message in the chat area
        function displayMessage(messageData) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-item');
            
            const senderName = messageData.senderId === currentUserId 
                ? 'You' 
                : usersMap[messageData.senderId] || 'Unknown User';
            
            const receiverName = usersMap[messageData.receiverId] || 'Unknown User';

            let headerText;
            if (messageData.senderId === currentUserId) {
                headerText = `To ${receiverName}: `;
            } else {
                headerText = `From ${senderName}: `;
            }

            messageDiv.innerHTML = `
                <span class="sender-name">${headerText}</span>
                <span class="message-text">${messageData.text}</span>
            `;
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // 4. Clears and sets up real-time message listener
        function setupMessageListener() {
            messageArea.innerHTML = '';
            
            // Query for messages where the current user is a participant
            const messagesCollection = collection(db, "messages");
            const q = query(messagesCollection, 
                where('participants', 'array-contains', currentUserId),
                orderBy('timestamp', 'asc')
            );

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                // Clear the whole chat area to redraw all messages (simpler)
                messageArea.innerHTML = '';
                if (snapshot.empty) {
                    messageArea.innerHTML = '<div class="text-center text-gray-400 mt-4">No messages yet. Start a conversation!</div>';
                }

                snapshot.forEach((doc) => {
                    displayMessage(doc.data());
                });
            }, (error) => {
                console.error("Error setting up message listener:", error);
                messageArea.innerHTML = `<div class="text-center text-red-400 mt-4">Error loading messages.</div>`;
            });
        }


        // --- Event Handlers ---

        toggleAuthButton.addEventListener('click', toggleAuthMode);
        document.getElementById('signout-button').addEventListener('click', () => signOut(auth));

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const email = emailInput.value;
            const password = passwordInput.value;
            const username = usernameInput.value.trim();
            
            authButton.textContent = isSigningIn ? 'Signing In...' : 'Registering...';
            authButton.disabled = true;

            try {
                let userCredential;
                if (isSigningIn) {
                    // --- SIGN IN LOGIC ---
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                } else {
                    // --- SIGN UP LOGIC ---
                    if (username.length < 3) {
                        throw new Error("Username must be at least 3 characters long.");
                    }
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Set the display name (username) and store in separate 'users' collection
                    await updateProfile(userCredential.user, { displayName: username });
                    await storeUserMetadata(userCredential.user.uid, username);
                }
            } catch (error) {
                displayError(error.message.replace("Firebase: ", ""));
            } finally {
                authButton.textContent = isSigningIn ? 'Sign In' : 'Sign Up';
                authButton.disabled = false;
            }
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const receiverId = recipientSelect.value;
            const text = messageInput.value.trim();

            if (!receiverId || !text) return;

            try {
                await addDoc(collection(db, "messages"), {
                    senderId: currentUserId,
                    receiverId: receiverId,
                    text: text,
                    timestamp: new Date(),
                    participants: [currentUserId, receiverId], // Used for querying
                });
                messageInput.value = '';
                // The onSnapshot listener handles displaying the new message
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message: " + error.message);
            }
        });


        // --- Authentication State Listener (Checks if user is logged in/out) ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                currentUserName = user.displayName || 'Guest';

                currentUsernameDisplay.textContent = `Logged in as: ${currentUserName}`;
                authScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');

                // Load users and set up message listener once signed in
                loadUsers();
                setupMessageListener();
            } else {
                // User is signed out
                currentUserId = null;
                currentUserName = null;
                authScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
                toggleAuthMode(); // Default back to Sign Up view
            }
        });

    </script>
</body>
</html>
