/**
 * Cloud Function to moderate chat messages for profanity and controversial words.
 * Messages are sent to a 'messages_pending' collection.
 * This function checks them and, if clean, moves them to the 'messages' collection.
 * If flagged, they are deleted from 'messages_pending'.
 */

const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();
const db = admin.firestore();

// Import the Language client library
const { LanguageServiceClient } = require('@google-cloud/language');
const languageClient = new LanguageServiceClient();

// --- Comprehensive Banned Word List ---
// This list is extensive and includes common profanity, slurs, and controversial terms.
// It's designed to catch variations and common bypasses.
// This list can be further expanded or loaded from a separate file/database for very large sets.
const BANNED_WORDS = [
    // General Profanity
    'fuck', 'shit', 'cunt', 'asshole', 'bitch', 'bastard', 'damn', 'hell', 'piss', 'dick', 'cock', 'tits', 'whore', 'slut', 'motherfucker', 'sonofabitch',
    'bollocks', 'bugger', 'arse', 'wanker', 'bloody', 'crap', 'twat', 'prick', 'minge', 'gobshite', 'bellend', 'choad', 'knobhead', 'spunk', 'cum', 'ejaculate', 'jizz',
    // Slurs/Hate Speech (examples - this list should be carefully curated and expanded as needed)
    'nigger', 'nigga', 'faggot', 'dyke', 'kike', 'gook', 'chink', 'paki', 'retard', 'spastic', 'cripple', 'tranny', 'shemale', 'wetback', 'beaner', 'cracker', 'white trash',
    'gypsy', 'jew', 'muslim', 'christian', 'hindu', 'buddhist', 'atheist', // Added for controversial religious terms if used as slurs
    // Controversial/Harmful Ideologies (examples)
    'nazi', 'hitler', 'kkk', 'supremacist', 'fascist', 'communist', 'terrorist', 'jihad', 'isis', 'al-qaeda', 'taliban', 'antifa', 'zionist', // Added for balance
    'genocide', 'holocaust', 'massacre', 'rape', 'pedophile', 'child molester', 'incest', 'bestiality', 'suicide', 'self-harm', 'kill yourself',
    // Drug-related (examples)
    'cocaine', 'heroin', 'meth', 'weed', 'pot', 'marijuana', 'ecstasy', 'mdma', 'lsd', 'opioid', 'fentanyl', 'crack', 'dope',
    // Sexual terms (if used offensively)
    'sex', 'porn', 'rape', 'orgasm', 'masturbate', 'threesome', 'gangbang', 'blowjob', 'handjob', 'rimjob', 'anal', 'vagina', 'penis', 'clitoris', 'scrotum',
    // More general strong language/insults
    'idiot', 'moron', 'stupid', 'loser', 'ugly', 'fat', 'dumb', 'crazy', 'insane', 'psycho', 'freak', 'weirdo', 'degenerate', 'scum', 'filth', 'vermin',
    'bastard', 'cretin', 'imbecile', 'nitwit', 'numbskull', 'dunce', 'bozo', 'clown', 'jerk', 'schmuck', 'punk', 'goon', 'thug', 'creep', 'pervert',
    'ass', 'butt', 'boob', 'turd', 'fart', 'smelly', 'gross', 'nasty', 'disgusting', 'vomit', 'barf', 'puke', 'suck', 'screw', 'screw you', 'sucks',
    // Expanded list for more coverage
    'abuser', 'addict', 'alcoholic', 'anarchist', 'antichrist', 'bigot', 'blasphemy', 'bomb', 'cannibal', 'chauvinist', 'cult', 'demon', 'devil',
    'discriminator', 'extremist', 'fanatic', 'gangster', 'hooligan', 'heretic', 'hypocrite', 'infidel', 'insurrection', 'jerkoff', 'liar', 'lunatic',
    'misogynist', 'molest', 'murder', 'obscene', 'oppressor', 'pervert', 'pig', 'prejudice', 'profane', 'racist', 'rebel', 'revolt', 'sadist', 'satan',
    'scam', 'sectarian', 'sinner', 'smut', 'snitch', 'sodomite', 'stalker', 'subversive', 'terror', 'torture', 'traitor', 'tyrant', 'unbeliever',
    'untermensch', 'useless', 'vandal', 'venom', 'villain', 'violence', 'vulgar', 'witch', 'xenophobe', 'zealot', 'zombie',
    // Common misspellings and leetspeak variations (simplified for regex, but effective)
    // This part is tricky. Instead of explicit leetspeak, we'll normalize the input.
    // The `normalizeText` function below will help catch many common bypasses.
];

// Create a regex for each banned word to catch variations with non-alphanumeric characters
// e.g., f.u.c.k, f-u-c-k, f_u_c_k, etc.
const BANNED_WORD_REGEXES = BANNED_WORDS.map(word => {
    // Escape special regex characters in the word, then allow any non-alphanumeric char
    // or space between letters.
    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regexPattern = escapedWord.split('').join('[^a-zA-Z0-9]*');
    return new RegExp(regexPattern, 'i'); // 'i' for case-insensitive
});


/**
 * Normalizes text for profanity detection by converting to lowercase
 * and removing non-alphanumeric characters (except spaces for now, might remove all later).
 * Also handles common leetspeak substitutions.
 * @param {string} text - The input text.
 * @returns {string} The normalized text.
 */
function normalizeText(text) {
    let normalized = text.toLowerCase();
    // Replace common leetspeak characters
    normalized = normalized.replace(/@/g, 'a');
    normalized = normalized.replace(/3/g, 'e');
    normalized = normalized.replace(/1/g, 'i');
    normalized = normalized.replace(/0/g, 'o');
    normalized = normalized.replace(/5/g, 's');
    normalized = normalized.replace(/7/g, 't');
    normalized = normalized.replace(/\$/g, 's'); // For dollar sign as 's'
    // Remove all non-alphanumeric characters (including spaces, to catch f u c k)
    normalized = normalized.replace(/[^a-z0-9]/g, '');
    return normalized;
}

/**
 * Checks if a given text contains any profanity from the banned list.
 * @param {string} text The message text to check.
 * @returns {boolean} True if profanity is found, false otherwise.
 */
function containsProfanity(text) {
    const normalizedText = normalizeText(text);
    functions.logger.log(`[Moderation] Normalized text: ${normalizedText}`);

    // Check against direct matches and regex patterns
    for (const bannedWord of BANNED_WORDS) {
        if (normalizedText.includes(bannedWord.replace(/[^a-z0-9]/g, ''))) {
            functions.logger.warn(`[Moderation] Direct match found: "${bannedWord}" in "${text}"`);
            return true;
        }
    }

    for (const regex of BANNED_WORD_REGEXES) {
        if (regex.test(text)) { // Test original text for regex patterns to catch spacing/punctuation bypasses
            functions.logger.warn(`[Moderation] Regex match found: "${regex.source}" in "${text}"`);
            return true;
        }
    }

    return false;
}

/**
 * Cloud Function triggered on new messages in 'messages_pending'.
 * Performs profanity moderation and moves clean messages to 'messages'.
 */
exports.moderateChatMessage = functions.firestore
    .document('apps/{projectId}/messages_pending/{messageId}')
    .onCreate(async (snap, context) => {
        const message = snap.data();
        const messageId = context.params.messageId;
        const projectId = context.params.projectId;
        const messageText = message.text;

        functions.logger.info(`[Moderation] New message received in pending: ${messageText} (ID: ${messageId})`);

        let isFlagged = false;

        // --- Profanity Detection ---
        if (containsProfanity(messageText)) {
            isFlagged = true;
            functions.logger.warn(`[Moderation] Message flagged by custom profanity filter: "${messageText}"`);
        } else {
            // Optional: Use Google Cloud Natural Language API for additional content moderation
            // This provides a more advanced, AI-driven moderation.
            // Uncomment this section if you want to use the Natural Language API.
            /*
            try {
                const document = {
                    content: messageText,
                    type: 'PLAIN_TEXT',
                };
                const [result] = await languageClient.analyzeSentiment({ document: document });
                const sentiment = result.documentSentiment;
                functions.logger.info(`[Moderation] Sentiment score: ${sentiment.score}, magnitude: ${sentiment.magnitude}`);

                // Example: Flag messages with very negative sentiment
                if (sentiment.score < -0.5 && sentiment.magnitude > 1.0) {
                    isFlagged = true;
                    functions.logger.warn(`[Moderation] Message flagged by sentiment analysis: "${messageText}" (Score: ${sentiment.score})`);
                }

                // You can also use analyzeContent for more detailed safety attributes
                const [classifyResult] = await languageClient.classifyText({ document: document });
                const categories = classifyResult.categories;
                if (categories && categories.length > 0) {
                    functions.logger.info(`[Moderation] Categories: ${JSON.stringify(categories)}`);
                    // Add logic to flag based on categories if needed
                }

            } catch (error) {
                functions.logger.error(`[Moderation] Error with Natural Language API: ${error.message}`);
                // Decide if API errors should lead to flagging or just logging
                // For robustness, you might consider flagging if API fails, or just proceed without NL analysis.
            }
            */
        }

        // --- Action based on Flagging ---
        if (isFlagged) {
            // Delete the message from messages_pending if it's flagged
            await snap.ref.delete();
            functions.logger.info(`[Moderation] Flagged message deleted from pending: ${messageId}`);
        } else {
            // If clean, move the message to the 'messages' collection
            const cleanMessageRef = db.collection(`apps/${projectId}/messages`).doc(messageId);
            await cleanMessageRef.set({
                ...message,
                status: 'approved', // Add a status field for clarity
                moderatedAt: admin.firestore.FieldValue.serverTimestamp()
            });
            // Delete from pending after successfully moving
            await snap.ref.delete();
            functions.logger.info(`[Moderation] Message approved and moved to messages: ${messageId}`);
        }
    });
