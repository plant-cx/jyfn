<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discussion Board with Email Verification</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and font */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* Light gray background */
            display: flex; /* Use flexbox for full page layout */
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }
        .message-container {
            display: flex;
            margin-bottom: 1rem;
            align-items: flex-start; /* Align items to the top */
        }
        .message-bubble {
            max-width: 70%; /* Limit bubble width */
            padding: 0.75rem 1rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            word-wrap: break-word; /* Ensure long words break */
            position: relative; /* For positioning edit/delete buttons */
            display: flex; /* Use flex to arrange text and buttons */
            flex-direction: column; /* Stack text and buttons */
            flex-grow: 1; /* Allow bubble to grow */
        }
        .sent {
            background-color: #3b82f6; /* Blue for sent messages */
            color: white;
            align-self: flex-end; /* Align to the right */
            border-bottom-right-radius: 0.5rem; /* Pointy corner for sent */
        }
        .received {
            background-color: #ffffff; /* White for received messages */
            color: #374151; /* Dark gray text */
            align-self: flex-start; /* Align to the left */
            border-bottom-left-radius: 0.5rem; /* Pointy corner for received */
        }
        .message-info {
            font-size: 0.75rem; /* Smaller font for info */
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }
        .timestamp {
            font-size: 0.65rem; /* Even smaller for timestamp */
            opacity: 0.7;
            margin-top: 0.25rem;
            text-align: right;
        }
        .message-actions {
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
            z-index: 10; /* Ensure buttons are above other content */
        }
        .message-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7); /* For sent messages */
            padding: 0.2rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .received .message-actions button {
            color: rgba(0, 0, 0, 0.5); /* For received messages */
        }
        .message-actions button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .loading-indicator, .error-message, .info-message {
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
            color: #6b7280;
        }
        .error-message {
            color: #dc2626;
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            margin: 1rem;
        }
        .info-message {
            color: #2563eb;
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 0.5rem;
            margin: 1rem;
        }
        /* Styling for the edit input field */
        .edit-input {
            width: 95%; /* Adjust width to fit within bubble */
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            box-sizing: border-box; /* Include padding in width */
            color: #374151; /* Ensure text color is visible */
        }
        .edit-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: flex-end;
        }
        .edit-buttons button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-buttons .save-button {
            background-color: #22c55e; /* Green */
            color: white;
        }
        .edit-buttons .save-button:hover {
            background-color: #16a34a;
        }
        .edit-buttons .cancel-button {
            background-color: #ef4444; /* Red */
            color: white;
        }
        .edit-buttons .cancel-button:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md rounded-b-lg flex justify-between items-center">
        <h1 class="text-3xl font-bold text-center flex-grow">Discussion Board</h1>
        <div class="flex items-center space-x-2">
            <p id="user-id-display" class="text-sm"></p>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded-full hidden">Logout</button>
        </div>
    </header>

    <!-- Auth Forms Container (Hidden by default) -->
    <div id="auth-container" class="flex flex-col items-center justify-center flex-grow p-4 bg-gray-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 id="auth-form-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Sign Up</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" id="auth-submit-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Sign Up</button>
            </form>
            <p class="mt-4 text-center text-sm text-gray-600">
                Already have an account? <button id="toggle-auth-mode" class="text-blue-600 hover:underline">Log In</button>
            </p>
            <div id="auth-error-message" class="text-red-600 text-sm text-center mt-4 hidden"></div>
        </div>
    </div>

    <!-- Messages Container -->
    <main id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
        <div id="loading-indicator" class="loading-indicator">Loading messages...</div>
        <div id="error-message" class="error-message hidden"></div>
        <div id="info-message" class="info-message hidden"></div>
        <div id="no-messages-indicator" class="text-center text-gray-500 mt-10 hidden">No messages yet. Be the first to start the discussion!</div>
        <!-- Messages will be appended here by JavaScript -->
    </main>

    <!-- Message Input Form -->
    <footer id="message-input-footer" class="bg-white p-4 shadow-lg rounded-t-lg hidden">
        <form id="message-form" class="flex space-x-3">
            <input
                type="text"
                id="message-input"
                placeholder="Type your message here..."
                class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled
            />
            <button
                type="submit"
                id="send-button"
                class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
            >
                Send
            </button>
        </form>
    </footer>

    <!-- Firebase SDKs and Application Logic -->
    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            sendEmailVerification,
            signOut // Import signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            updateDoc, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // YOUR FIREBASE CONFIGURATION - This is critical for your app to connect to Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCN5LWuSS5V2Js8JhLEm7KCiuYZA-BP0a0", // From your last correct config
            authDomain: "chat-d312d.firebaseapp.com",
            projectId: "chat-d312d",
            storageBucket: "chat-d312d.firebasestorage.app",
            messagingSenderId: "153824285530",
            appId: "1:153824285530:web:d918e824233704842fd963",
            measurementId: "G-CJKMEBMWD2"
        };

        // --- Random Username Generation ---
        const ADJECTIVES = ["Happy", "Brave", "Clever", "Shiny", "Quiet", "Loud", "Swift", "Bright", "Calm", "Witty", "Gentle", "Fierce", "Lucky", "Wise", "Bold", "Kind", "Silly", "Graceful", "Curious", "Vivid"];
        const NOUNS = ["Panda", "Tiger", "Eagle", "Star", "River", "Cloud", "Stone", "Whisper", "Echo", "Blossom", "Shadow", "Spirit", "Comet", "Voyager", "Pixel", "Gizmo", "Spark", "Bolt", "Dreamer", "Nomad"];

        function generateRandomUsername() {
            const randomAdjective = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const randomNoun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            return `${randomAdjective}${randomNoun}`; // e.g., "HappyPanda"
        }

        function getOrCreateUsername() {
            let username = sessionStorage.getItem('chatUsername');
            if (!username) {
                username = generateRandomUsername();
                sessionStorage.setItem('chatUsername', username);
            }
            return username;
        }
        // --- End Random Username Generation ---

        // Wait for the DOM to be fully loaded before running JavaScript
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // DOM elements
            const messagesContainer = document.getElementById('messages-container');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const userIdDisplay = document.getElementById('user-id-display');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessageDiv = document.getElementById('error-message');
            const infoMessageDiv = document.getElementById('info-message'); // New info message div
            const noMessagesIndicator = document.getElementById('no-messages-indicator');
            const authContainer = document.getElementById('auth-container');
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authFormTitle = document.getElementById('auth-form-title');
            const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
            const authErrorMessage = document.getElementById('auth-error-message');
            const logoutButton = document.getElementById('logout-button');
            const messageInputFooter = document.getElementById('message-input-footer');


            let currentUserId = null; // To store the authenticated user's ID
            let currentUsername = getOrCreateUsername(); // Get or create the random username
            let isLoginMode = false; // To toggle between login and signup

            // Function to display errors (general app errors)
            function displayError(message) {
                errorMessageDiv.textContent = `Error: ${message}`;
                errorMessageDiv.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                infoMessageDiv.classList.add('hidden'); // Hide info if error occurs
                console.error("App Error:", message); // Log to console for debugging
            }

            // Function to display info messages
            function displayInfo(message) {
                infoMessageDiv.textContent = `Info: ${message}`;
                infoMessageDiv.classList.remove('hidden');
                errorMessageDiv.classList.add('hidden'); // Hide error if info occurs
                loadingIndicator.classList.add('hidden');
            }

            // Function to hide all general messages (error, info, loading)
            function hideAllMessages() {
                errorMessageDiv.classList.add('hidden');
                infoMessageDiv.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
            }

            // Function to scroll to the bottom of the messages container
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Function to handle message deletion
            async function handleDeleteMessage(messageId) {
                if (!window.confirm('Are you sure you want to delete this message?')) {
                    return; // User cancelled
                }
                try {
                    const messageRef = doc(db, `apps/${firebaseConfig.projectId}/messages`, messageId);
                    await deleteDoc(messageRef);
                    console.log(`Message ${messageId} deleted successfully.`);
                } catch (e) {
                    console.error("Error deleting message: ", e);
                    displayError(`Failed to delete message: ${e.message}`);
                }
            }

            // Function to handle message editing
            function handleEditMessage(messageId, currentText) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (!messageElement) return;

                const originalTextP = messageElement.querySelector('p');
                const actionsDiv = messageElement.querySelector('.message-actions');

                if (originalTextP) originalTextP.style.display = 'none';
                if (actionsDiv) actionsDiv.style.display = 'none';

                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.value = currentText;
                editInput.classList.add('edit-input');
                originalTextP.parentNode.insertBefore(editInput, originalTextP.nextSibling);
                editInput.focus();
                editInput.select();

                const editButtonsDiv = document.createElement('div');
                editButtonsDiv.classList.add('edit-buttons');

                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.classList.add('save-button');
                saveButton.onclick = async () => {
                    const newText = editInput.value.trim();
                    if (newText === '') {
                        displayError("Message cannot be empty.");
                        return;
                    }
                    try {
                        const messageRef = doc(db, `apps/${firebaseConfig.projectId}/messages`, messageId);
                        await updateDoc(messageRef, {
                            text: newText,
                            timestamp: serverTimestamp()
                        });
                        console.log(`Message ${messageId} updated.`);
                    } catch (e) {
                        console.error("Error updating message: ", e);
                        displayError(`Failed to update message: ${e.message}`);
                    }
                };

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.classList.add('cancel-button');
                cancelButton.onclick = () => {
                    if (originalTextP) originalTextP.style.display = '';
                    if (actionsDiv) actionsDiv.style.display = '';
                    editInput.remove();
                    editButtonsDiv.remove();
                };

                editButtonsDiv.appendChild(saveButton);
                editButtonsDiv.appendChild(cancelButton);
                messageElement.appendChild(editButtonsDiv);
            }

            // Function to render a single message
            function renderMessage(msg) {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('message-container');
                messageWrapper.classList.add(msg.userId === currentUserId ? 'justify-end' : 'justify-start');

                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble');
                messageBubble.classList.add(msg.userId === currentUserId ? 'sent' : 'received');
                messageBubble.setAttribute('data-message-id', msg.id);

                const userInfo = document.createElement('div');
                userInfo.classList.add('message-info');
                userInfo.textContent = msg.userId === currentUserId ? 'You' : `User: ${msg.username || 'Unknown User'}`;
                messageBubble.appendChild(userInfo);

                const messageText = document.createElement('p');
                messageText.textContent = msg.text;
                messageBubble.appendChild(messageText);

                const timestampDiv = document.createElement('div');
                timestampDiv.classList.add('timestamp');
                if (msg.timestamp && typeof msg.timestamp.toDate === 'function') {
                    timestampDiv.textContent = msg.timestamp.toDate().toLocaleString();
                } else {
                    timestampDiv.textContent = 'Sending...';
                }
                messageBubble.appendChild(timestampDiv);

                if (msg.userId === currentUserId) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('message-actions');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'âœï¸';
                    editButton.title = 'Edit Message';
                    editButton.onclick = () => handleEditMessage(msg.id, msg.text);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'ðŸ—‘ï¸';
                    deleteButton.title = 'Delete Message';
                    deleteButton.onclick = () => handleDeleteMessage(msg.id);

                    actionsDiv.appendChild(editButton);
                    actionsDiv.appendChild(deleteButton);
                    messageBubble.appendChild(actionsDiv);
                }

                messageWrapper.appendChild(messageBubble);
                messagesContainer.appendChild(messageWrapper);
            }

            // Function to start real-time message listener
            function startMessageListener() {
                if (!db) {
                    displayError("Firestore not initialized.");
                    return;
                }
                const messagesCollectionRef = collection(db, `apps/${firebaseConfig.projectId}/messages`);
                const q = query(messagesCollectionRef, orderBy('timestamp'));

                onSnapshot(q, (snapshot) => {
                    hideAllMessages();
                    messagesContainer.innerHTML = '';

                    if (snapshot.empty) {
                        noMessagesIndicator.classList.remove('hidden');
                    } else {
                        noMessagesIndicator.classList.add('hidden');
                        snapshot.forEach((doc) => {
                            renderMessage({ id: doc.id, ...doc.data() });
                        });
                        scrollToBottom();
                    }
                }, (error) => {
                    console.error("Error fetching messages:", error);
                    displayError(`Failed to load messages: ${error.message}`);
                });
            }

            // Event listener for sending messages
            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = messageInput.value.trim();

                // Check if user is authenticated and email is verified
                if (!auth.currentUser || !auth.currentUser.emailVerified) {
                    displayError("You must verify your email to send messages.");
                    return;
                }

                if (messageText === '') {
                    return; // Don't send empty messages
                }

                try {
                    await addDoc(collection(db, `apps/${firebaseConfig.projectId}/messages`), {
                        text: messageText,
                        timestamp: serverTimestamp(),
                        userId: auth.currentUser.uid, // Use authenticated user's UID
                        username: currentUsername // Include the random username
                    });
                    messageInput.value = ''; // Clear input
                    hideAllMessages();
                    scrollToBottom();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    displayError(`Failed to send message: ${e.message}`);
                }
            });

            // --- Authentication Logic ---
            let unsubscribeAuth = null; // To store the auth listener unsubscribe function

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = `Your Username: ${currentUsername}`;
                    logoutButton.classList.remove('hidden');
                    authContainer.classList.add('hidden'); // Hide auth forms

                    if (user.emailVerified) {
                        displayInfo("Email verified. You can now send messages!");
                        messagesContainer.classList.remove('hidden'); // Show chat
                        messageInputFooter.classList.remove('hidden'); // Show input
                        messageInput.disabled = false;
                        sendButton.disabled = false;
                        startMessageListener(); // Start listening for messages
                    } else {
                        displayInfo("Please verify your email. Check your inbox for a verification link.");
                        messagesContainer.classList.add('hidden'); // Hide chat
                        messageInputFooter.classList.add('hidden'); // Hide input
                        messageInput.disabled = true;
                        sendButton.disabled = true;
                        // Offer to resend verification email
                        const resendButton = document.createElement('button');
                        resendButton.textContent = 'Resend Verification Email';
                        resendButton.className = 'mt-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md';
                        resendButton.onclick = async () => {
                            try {
                                await sendEmailVerification(user);
                                displayInfo("Verification email sent! Please check your inbox.");
                            } catch (error) {
                                console.error("Error resending verification email:", error);
                                displayError(`Failed to resend verification email: ${error.message}`);
                            }
                        };
                        infoMessageDiv.appendChild(resendButton); // Append resend button to info message
                    }
                    console.log("User signed in:", user.uid, "Email Verified:", user.emailVerified);
                } else {
                    currentUserId = null;
                    userIdDisplay.textContent = '';
                    logoutButton.classList.add('hidden');
                    authContainer.classList.remove('hidden'); // Show auth forms
                    messagesContainer.classList.add('hidden'); // Hide chat
                    messageInputFooter.classList.add('hidden'); // Hide input
                    messageInput.disabled = true;
                    sendButton.disabled = true;
                    hideAllMessages(); // Clear any previous messages
                    console.log("User signed out.");
                }
            });

            // Toggle between Sign Up and Log In forms
            toggleAuthModeButton.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                authFormTitle.textContent = isLoginMode ? 'Log In' : 'Sign Up';
                authSubmitButton.textContent = isLoginMode ? 'Log In' : 'Sign Up';
                toggleAuthModeButton.textContent = isLoginMode ? 'Create an account' : 'Log In';
                authErrorMessage.classList.add('hidden'); // Clear previous errors
            });

            // Handle Sign Up / Log In form submission
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                authErrorMessage.classList.add('hidden'); // Hide previous errors

                if (email === '' || password === '') {
                    authErrorMessage.textContent = 'Email and password cannot be empty.';
                    authErrorMessage.classList.remove('hidden');
                    return;
                }

                try {
                    if (isLoginMode) {
                        await signInWithEmailAndPassword(auth, email, password);
                        displayInfo("Logged in successfully!");
                    } else {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await sendEmailVerification(userCredential.user);
                        displayInfo("Account created! Please check your email to verify your account.");
                    }
                    emailInput.value = '';
                    passwordInput.value = '';
                } catch (error) {
                    console.error("Auth error:", error);
                    let errorMessage = "Authentication failed.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already in use. Try logging in or use a different email.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password should be at least 6 characters.';
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Invalid email or password.';
                    }
                    authErrorMessage.textContent = errorMessage;
                    authErrorMessage.classList.remove('hidden');
                }
            });

            // Handle Logout
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    sessionStorage.removeItem('chatUsername'); // Clear username on logout
                    displayInfo("You have been logged out.");
                } catch (error) {
                    console.error("Error logging out:", error);
                    displayError(`Failed to log out: ${error.message}`);
                }
            });

        }); // End of DOMContentLoaded
    </script>
</body>
</html>
